Name:     @PACKAGE_TARNAME@
Summary:  The RObust Header Compression (ROHC) library
Group:    System Environment/Libraries
License:  LGPLv2+
URL:      @PACKAGE_URL@

Epoch:    0
Version:  @PACKAGE_VERSION@@PACKAGE_REVNO@
Release:  1.%{packager}

BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

Source:   %{name}-%{version}.tar.xz

# libpcap and cmocka required by unit tests
BuildRequires: libcmocka-devel
%if 0%{?rhel_version} >= 600
BuildRequires: libpcap1-devel
%else
BuildRequires: libpcap-devel
%endif

%global _hardened_build 1

# do we generate documentation?
#  - RHEL >= 6
#  - CentOS >= 6
#  - all others
%if 0%{?rhel_version} || 0%{?centos_ver}
# RHEL or CentOS
%if 0%{?rhel_version} >= 600
%define rohc_doc 1
%else
%if 0%{?centos_ver} >= 6
%define rohc_doc 1
%else
%define rohc_doc 0
%endif
%endif
# end RHEL or CentOS
%else
# !RHEL && !CentOS
%define rohc_doc 1
# end !RHEL && !CentOS
%endif

%description
The ROHC library implements the RObust Header Compression (ROHC)
algorithms as defined by the IETF in RFC3095.


%package tools
Summary:       Miscellaneous tools that come along the ROHC library
Group:         Development/Libraries
Requires:      %{name} = %{epoch}:%{version}-%{release}
%if 0%{?rhel_version} >= 600
Requires:      libpcap1
BuildRequires: libpcap1-devel
%else
Requires:      libpcap
BuildRequires: libpcap-devel
%endif
# rohc_stats.sh uses gnuplot to draw graphs
Requires:      gnuplot

%description tools
Miscellaneous tools that come along the ROHC library.

The ROHC library implements the RObust Header Compression (ROHC)
algorithms as defined by the IETF in RFC3095.


%package devel
Summary:       Files for development of applications which will use the ROHC library
Group:         Development/Libraries
BuildArch:     noarch
Requires:      %{name} = %{epoch}:%{version}-%{release}
BuildRequires: help2man

%description devel
Files for development of applications which will use the ROHC library.

The ROHC library implements the RObust Header Compression (ROHC)
algorithms as defined by the IETF in RFC3095.


%package doc
Summary:       API documentation of the ROHC library
Group:         Development/Libraries
BuildArch:     noarch
Requires:      %{name} = %{epoch}:%{version}-%{release}
%if %{rohc_doc}
BuildRequires: doxygen
BuildRequires: graphviz
%if 0%{?suse_version}
BuildRequires: graphviz-gd
%endif
%endif

%description doc
API documentation of the ROHC library.

The ROHC library implements the RObust Header Compression (ROHC)
algorithms as defined by the IETF in RFC3095.


%prep
# unpack sources
%setup -q

%build
# configure for tools, doc and tests
%configure \
	--enable-app-performance \
	--enable-app-sniffer \
	--enable-app-stats \
%if %{rohc_doc}
	--enable-doc \
%endif
	--enable-examples \
	--enable-fail-on-warning \
	--enable-fortify-sources \
	--enable-rohc-tests \
	--enable-shared \
	--disable-static
make clean
# build the library, tools and doc
# disable some warnings on CentOS 6.x
%if 0%{?centos_ver} == 06
export MY_CFLAGS="-Wno-unreachable-code"
%else
export MY_CFLAGS=""
%endif
make %{?_smp_mflags} all CFLAGS="${CFLAGS} ${MY_CFLAGS}"

%check
# build and run tests
# disable some warnings on CentOS 6.x
%if 0%{?centos_ver} == 06
export MY_CFLAGS="-Wno-unreachable-code"
%else
export MY_CFLAGS=""
%endif
make %{?_smp_mflags} check CFLAGS="${CFLAGS} ${MY_CFLAGS}"

%install
rm -rf %{buildroot}
# install library, tools and doc
make install DESTDIR=%{buildroot}
# remove useless libtool .la file
rm -f %{buildroot}/%{_libdir}/librohc.la

%clean
rm -rf %{buildroot}

%post -p /sbin/ldconfig
%postun -p /sbin/ldconfig

%files
%defattr(0644, root, root, 0755)
# libraries
%{_libdir}/librohc.so
%{_libdir}/librohc.so.3
%{_libdir}/librohc.so.3.0.0
# basic documentation
%dir %{_defaultdocdir}/%{name}/
%{_docdir}/%{name}/AUTHORS.md
%{_docdir}/%{name}/AUTHORS
%{_docdir}/%{name}/COPYING
%{_docdir}/%{name}/ChangeLog
%{_docdir}/%{name}/INSTALL.md
%{_docdir}/%{name}/INSTALL
%{_docdir}/%{name}/README.md
%{_docdir}/%{name}/README
# general man pages
%{_mandir}/man7/rohc.7.gz
%{_mandir}/man7/rohc_protocol.7.gz
%{_mandir}/man7/rohc_library.7.gz

%files tools
%defattr(0644, root, root, 0755)
# library tools
%{_bindir}/rohc_test_performance
%{_bindir}/rohc_gen_stream
%{_bindir}/rohc_stats
%{_bindir}/rohc_stats.sh
%{_sbindir}/rohc_sniffer
# tools man pages
%{_mandir}/man1/*.1.gz

%files devel
%defattr(0644, root, root, 0755)
# pkgconfig definition
%{_libdir}/pkgconfig/rohc.pc
# library headers
%dir %{_includedir}/%{name}/
%{_includedir}/%{name}/rohc.h
%{_includedir}/%{name}/rohc_buf.h
%{_includedir}/%{name}/rohc_comp.h
%{_includedir}/%{name}/rohc_decomp.h
%{_includedir}/%{name}/rohc_packets.h
%{_includedir}/%{name}/rohc_time.h
%{_includedir}/%{name}/rohc_traces.h
# code examples
%dir %{_docdir}/%{name}/
%dir %{_docdir}/%{name}/examples/
%{_docdir}/%{name}/examples/*.c

%files doc
%defattr(0644, root, root, 0755)
# doxygen documentation in HTML format
%if %{rohc_doc}
%dir %{_docdir}/%{name}/
%dir %{_docdir}/%{name}/html/
%{_docdir}/%{name}/html/*
%endif
# man pages for development
%{_mandir}/man3/*.3.gz

%changelog
* Sat Jun 25 2016 Didier Barvaux <didier@barvaux.org>
- Remove deprecated tunnel and fuzzer apps
- Install man pages
- Remove now useless latex dependency for doc
* Mon May 20 2013 Didier Barvaux <didier@barvaux.org>
- Replace --enable-rohc-apps by --enable-app-fuzzer --enable-app-tunnel
  --enable-app-performance --enable-app-sniffer.
* Thu May  9 2013 Didier Barvaux <didier@barvaux.org>
- depend on libpcap1 on RHEL >= 6
- define devel and doc subpackages as noarch
- add texlive-bin as build dependency for OpenSuse
- add texlive-latex-bin-bin dependency for Fedora >= 18
- _replace _defaultdocdir by _docdir
- rework the way we decide whether doc shall be generated or not
- use libpcap1-devel instead of libpcap-devel on RHEL6
- do not generate documentation on CentOS5 and RHEL5
- add graphviz-gd as build dependency on OpenSuse
* Wed May  8 2013 Didier Barvaux <didier@barvaux.org>
- add the test archive as additional source
- add graphviz as build dependency for doc subpackage
- add texlive-latex as build dependency for doc subpackage
- split tools in a subpackage
- add build and runtime dependencies for tools
- first version.
